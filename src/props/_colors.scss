@use "prefixes" as *;
@use "sass:map";

// ============================================
// Overridable Variants
// ============================================

// ============================================
// デフォルト明度リスト（0-10）
// ============================================
// key: 輝度名
// value: 輝度値
// ============================================
$palette-default-lightness-list: (
  0: 97%,
  1: 93%,
  2: 85%,
  3: 75%,
  4: 65%,
  5: 50%,
  6: 42%,
  7: 34%,
  8: 26%,
  9: 18%,
  10: 10%,
) !default;

// ============================================
// デフォルトレベルリスト
// ============================================
// key: レベル名
// value: 輝度名
// ============================================
$palette-default-level-list: (
  "lighter": 2,
  "light": 3,
  "default": 5,
  "dark": 7,
  "darker": 9,
) !default;

// アクセント輝度（明）
$palette-accent-light-lightness: 97% !default;
// アクセント輝度（暗）
$palette-accent-dark-lightness: 10% !default;
// アクセント
$palette-accent-default-threshold: 50% !default;
// グレーの彩度
$palette-gray-saturation: 5% !default;

// ============================================
// デフォルトパレット定義リスト
// ============================================
// key: パレット名
// value: パレットプロパティリスト
//   h: 色相
//   s: 彩度
//   lightnesses: 輝度リスト
//     key: 輝度名
//     value: 輝度値
//   threshold: アクセント切り替え輝度
//   levels: レベルリスト
//     key: レベル名
//     value: 輝度名
// ============================================
$palettes: (
  "primary": (
    h: 220,
    s: 80%,
    levels: (
      lighter: 2,
      light: 3,
      default: 6,
      dark: 8,
      darker: 9,
    ),
  ),
  "secondary": (
    h: 330,
    s: 80%,
    threshold: 55%,
    levels: (
      lighter: 2,
      light: 3,
      default: 5,
      dark: 7,
      darker: 9,
    ),
  ),
  "tertiary": (
    h: 170,
    s: 60%,
    threshold: 40%,
    levels: (
      lighter: 2,
      light: 4,
      default: 7,
      dark: 9,
      darker: 10,
    ),
  ),
  "success": (
    h: 125,
    s: 60%,
    threshold: 45%,
    levels: (
      lighter: 2,
      light: 4,
      default: 7,
      dark: 9,
      darker: 10,
    ),
  ),
  "warning": (
    h: 50,
    s: 80%,
    threshold: 45%,
    levels: (
      lighter: 2,
      light: 4,
      default: 6,
      dark: 8,
      darker: 9,
    ),
  ),
  "danger": (
    h: 0,
    s: 80%,
    threshold: 50%,
    levels: (
      lighter: 2,
      light: 4,
      default: 6,
      dark: 8,
      darker: 9,
    ),
  ),
  "info": (
    h: 190,
    s: 80%,
    threshold: 40%,
    levels: (
      lighter: 2,
      light: 4,
      default: 7,
      dark: 8,
      darker: 9,
    ),
  ),
) !default;

//=============================================
// Mixins
// ============================================

// ============================================
// Palette Color Generation Mixin
// ============================================
// $palette-lightness-list: 輝度リスト
// $palette-level-list: レベルリスト
// $threshold: Accent Color Threshold
// ============================================
@mixin _generate-palette-colors(
  $palette-lightness-list,
  $palette-level-list,
  $threshold
) {
  // 輝度値のCSS変数定義
  @each $key, $lightness in $palette-lightness-list {
    @if type-of($lightness) == "map" {
      @error "カラーパレット生成エラー: 輝度に連想配列を指定することはできません。";
    }
    --#{$palette-lightness-prefix}#{$key}: #{$lightness};
  }

  // 実際の色のCSS変数定義
  @each $key, $lightness in $palette-lightness-list {
    --#{$palette-color-prefix}#{$key}: hsl(
      var(#{$palette-hue-var}),
      var(#{$palette-saturation-var}),
      var(--#{$palette-lightness-prefix}#{$key})
    );
  }

  // グレー色のCSS変数定義
  @each $key, $lightness in $palette-lightness-list {
    --#{$palette-gray-prefix}#{$key}: hsl(
      var(#{$palette-hue-var}),
      var(#{$palette-gray-saturation-var}),
      var(--#{$palette-lightness-prefix}#{$key})
    );
  }

  // アクセント色のCSS変数定義
  @each $key, $lightness in $palette-lightness-list {
    @if type-of($threshold) == "map" {
      @error "カラーパレット生成エラー: アクセントの輝度閾値に連想配列を指定することはできません。";
    }
    @if $lightness > $threshold {
      --#{$palette-accent-prefix}#{$key}: hsl(
        var(#{$palette-hue-var}),
        var(#{$palette-gray-saturation-var}),
        var(#{$palette-accent-dark-lightness-var})
      );
    } @else {
      --#{$palette-accent-prefix}#{$key}: hsl(
        var(#{$palette-hue-var}),
        var(#{$palette-gray-saturation-var}),
        var(#{$palette-accent-light-lightness-var})
      );
    }
  }

  // レベルリスト
  @each $level-name, $step-key in $palette-level-list {
    @if type-of($step-key) == "map" {
      @error "カラーパレット生成エラー: レベルの輝度キーに連想配列を指定することはできません。";
    }
    @if not map.has-key($palette-lightness-list, $step-key) {
      @error "カラーパレット生成エラー: レベル '#{$level-name}' に指定された輝度キー '#{$step-key}' は、輝度リストに存在しません。利用可能なキー: #{map.keys($palette-lightness-list)}";
    }

    --#{$palette-prefix}#{$level-name}: var(
      --#{$palette-color-prefix}#{$step-key}
    );
    --#{$palette-accent-prefix}#{$level-name}: var(
      --#{$palette-accent-prefix}#{$step-key}
    );
  }
}

@mixin generate-palette-variants($palette) {
  @if not type-of($palette) == "map" {
    @error "カラーパレット生成エラー: パレットの値には連想配列を指定してください。";
  }
  @if not map.has-key($palette, h) {
    @error "カラーパレット生成エラー: パレットの値に色相（h）が含まれていません。";
  }
  @if not map.has-key($palette, s) {
    @error "カラーパレット生成エラー: パレットの値に彩度（s）が含まれていません。";
  }

  #{$palette-hue-var}: #{map.get($palette, h)};
  #{$palette-saturation-var}: #{map.get($palette, s)};
  #{$palette-accent-light-lightness-var}: #{$palette-accent-light-lightness};
  #{$palette-accent-dark-lightness-var}: #{$palette-accent-dark-lightness};
  #{$palette-gray-saturation-var}: #{$palette-gray-saturation};

  @include _generate-palette-colors(
    $palette-lightness-list: map.get($palette, lightness-list) or
      $palette-default-lightness-list,
    $palette-level-list: map.get($palette, levels) or
      $palette-default-level-list,
    $threshold: map.get($palette, threshold) or
      $palette-accent-default-threshold
  );
}

// Generic palette generator that allows overriding the variable name prefixes.
// $names is a map with optional keys:
//   lightness-prefix, color-prefix, accent-prefix, gray-prefix, prefix (base),
//   hue-var, saturation-var, gray-saturation-var,
//   accent-light-lightness-var, accent-dark-lightness-var,
//   threshold, lightness-list, levels
@mixin generate-palette-with-prefixes($palette, $names) {
  @if not type-of($palette) == "map" {
    @error "カラーパレット生成エラー: パレットの値には連想配列を指定してください。";
  }

  // resolve prefixes and var names (fall back to defaults used by props)
  $lightness-prefix: map.get($names, lightness-prefix) or
    $palette-lightness-prefix;
  $color-prefix: map.get($names, color-prefix) or $palette-color-prefix;
  $accent-prefix: map.get($names, accent-prefix) or $palette-accent-prefix;
  $gray-prefix: map.get($names, gray-prefix) or $palette-gray-prefix;
  $base-prefix: map.get($names, prefix) or $palette-prefix;

  $hue-var: map.get($names, hue-var) or $palette-hue-var;
  $saturation-var: map.get($names, saturation-var) or $palette-saturation-var;
  $gray-sat-var: map.get($names, gray-saturation-var) or
    $palette-gray-saturation-var;
  $accent-light-l-var: map.get($names, accent-light-lightness-var) or
    $palette-accent-light-lightness-var;
  $accent-dark-l-var: map.get($names, accent-dark-lightness-var) or
    $palette-accent-dark-lightness-var;

  // local lightness/levels
  $lightness-list: map.get($names, lightness-list) or
    map.get($palette, lightness-list) or $palette-default-lightness-list;
  $level-list: map.get($names, level-list) or map.get($palette, level-list) or
    // Support legacy 'levels' key as well
    map.get($palette, levels) or $palette-default-level-list;
  $threshold: map.get($names, threshold) or map.get($palette, threshold) or
    $palette-accent-default-threshold;

  // write hue/saturation vars (use provided var names or defaults)
  // if $hue-var is a string like "--neutral-h" we want to emit that variable
  // with the palette's h value. But if $hue-var is already a var reference
  // (e.g. --palette-h) it's fine.
  #{unquote($hue-var)}: #{map.get($palette, h)};
  #{unquote($saturation-var)}: #{map.get($palette, s)};

  // generate lightness variables
  @each $key, $lightness in $lightness-list {
    --#{$lightness-prefix}#{$key}: #{$lightness};
  }

  // colors
  @each $key, $lightness in $lightness-list {
    --#{$color-prefix}#{$key}: hsl(
      var(#{$hue-var}),
      var(#{$saturation-var}),
      var(--#{$lightness-prefix}#{$key})
    );
  }

  // gray variants
  @each $key, $lightness in $lightness-list {
    --#{$gray-prefix}#{$key}: hsl(
      var(#{$hue-var}),
      var(#{$gray-sat-var}),
      var(--#{$lightness-prefix}#{$key})
    );
  }

  // accents
  @each $key, $lightness in $lightness-list {
    @if $lightness > $threshold {
      --#{$accent-prefix}#{$key}: hsl(
        var(#{$hue-var}),
        var(#{$gray-sat-var}),
        var(#{$accent-dark-l-var})
      );
    } @else {
      --#{$accent-prefix}#{$key}: hsl(
        var(#{$hue-var}),
        var(#{$gray-sat-var}),
        var(#{$accent-light-l-var})
      );
    }
  }

  // level shortcuts
  @each $level-name, $step-key in $level-list {
    --#{$base-prefix}#{$level-name}: var(--#{$color-prefix}#{$step-key});
    --#{$accent-prefix}#{$level-name}: var(--#{$accent-prefix}#{$step-key});
  }
}

//=============================================
// Process
// ============================================
@each $name, $value in $palettes {
  .#{$prefix}#{$name} {
    @include generate-palette-variants($value);
  }
}
